{% extends "base.html" %}

{% block title %}Admin Dashboard - Incident Reporting System{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 style="color: var(--text-primary);">Incident Reports Dashboard</h1>
        <a href="{{ url_for('export_incidents') }}" class="btn btn-primary">Export to CSV</a>
    </div>

    <div class="search-bar">
        <input type="text" id="searchInput" class="form-input search-input" placeholder="Search incidents...">
    </div>
    
    <div class="filter-controls">
        <div class="date-filters">
            <label for="startDate" style="font-weight: 500; color: var(--text-primary);">From:</label>
            <input type="date" id="startDate" class="form-input" style="width: auto;">
            <label for="endDate" style="font-weight: 500; color: var(--text-primary);">To:</label>
            <input type="date" id="endDate" class="form-input" style="width: auto;">
            <button id="clearDates" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.75rem;">Clear Dates</button>
        </div>
        <div class="sort-controls">
            <label for="sortBy" style="font-weight: 500; color: var(--text-primary);">Sort by:</label>
            <select id="sortBy" class="form-input" style="width: auto;">
                <option value="submitted_at">Submission Date</option>
                <option value="incident_datetime">Incident Date</option>
                <option value="incident_type">Incident Type</option>
                <option value="reporter_name">Reporter Name</option>
                <option value="location">Location</option>
            </select>
            <select id="sortOrder" class="form-input" style="width: auto;">
                <option value="desc">Newest First</option>
                <option value="asc">Oldest First</option>
            </select>
        </div>
    </div>

    <div id="incidentsContainer">
        <div class="loading">Loading incidents...</div>
    </div>
</div>

<!-- Incident Details Modal -->
<div id="incidentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Incident Details</h2>
            <div class="modal-header-buttons">
                <button id="saveModalBtn" class="btn btn-primary btn-sm">Save</button>
                <button id="exportPdfModalBtn" class="btn btn-outline btn-sm" disabled>Export PDF</button>
                {% if is_master_admin %}
                <button id="deleteIncidentBtn" class="btn btn-danger btn-sm" style="display: none;">Delete Incident</button>
                {% endif %}
                <span class="close">&times;</span>
            </div>
        </div>
        <div class="modal-body">
            <div class="incident-details">
                <!-- Corrective Actions Section - Full Width at Top -->
                <div class="detail-section full-width">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-color); font-size: 1rem;">Corrective Actions</h4>
                    
                    <!-- Audit Trail Display -->
                    <div class="detail-row" id="auditTrailRow" style="display: none;">
                        <div class="detail-label">Previous Actions</div>
                        <div class="audit-trail-container">
                            <div id="auditTrailDisplay" class="audit-trail-display" style="background-color: var(--background-color); padding: 0.75rem; border-radius: 0.375rem; border: 1px solid var(--border-color); font-size: 0.875rem; color: var(--text-secondary); max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    
                    <!-- New Corrective Actions Input -->
                    <div class="detail-row">
                        <div class="detail-label">Add New Corrective Actions</div>
                        <div class="corrective-actions-container">
                            <textarea id="modalCorrectiveActions" class="form-textarea corrective-actions-textarea" 
                                      placeholder="Enter new corrective actions..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Notification Checkbox -->
                    <div class="detail-row" style="margin-top: 0.75rem;">
                        <div class="detail-label">Notification</div>
                        <div class="notification-container" style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="notifyReporterCheckbox" class="form-checkbox">
                            <label for="notifyReporterCheckbox" class="form-checkbox-label" style="font-size: 0.875rem; color: var(--text-secondary);">
                                Notify reporter of corrective actions update
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Two Column Layout -->
                <div class="modal-columns">
                    <!-- Left Column -->
                    <div class="modal-column">
                        <!-- Reporter Information -->
                        <div class="detail-section">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-color); font-size: 1rem;">Reporter Information</h4>
                            <div class="detail-row">
                                <div class="detail-label">Name</div>
                                <div class="detail-value" id="modalReporter"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Job Title</div>
                                <div class="detail-value" id="modalJobTitle"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Email</div>
                                <div class="detail-value" id="modalEmail"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value" id="modalPhone"></div>
                            </div>
                        </div>
                        
                        <!-- Incident Details -->
                        <div class="detail-section">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-color); font-size: 1rem;">Incident Details</h4>
                            <div class="detail-row">
                                <div class="detail-label">Type</div>
                                <div class="detail-value" id="modalIncidentType"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Date/Time</div>
                                <div class="detail-value" id="modalIncidentDateTime"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Location</div>
                                <div class="detail-value" id="modalLocation"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Description of What Happened</div>
                                <div class="detail-value scrollable" id="modalIncidentDescription"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Persons Involved</div>
                                <div class="detail-value scrollable" id="modalPersonsInvolved"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="modal-column">
                        <!-- Additional Details -->
                        <div class="detail-section">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-color); font-size: 1rem;">Additional Details</h4>
                            <div class="detail-row">
                                <div class="detail-label">Threats, Physical Acts, or Weapons</div>
                                <div class="detail-value scrollable" id="modalThreatsWeapons"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Medical Treatment</div>
                                <div class="detail-value scrollable" id="modalMedicalTreatment"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Law Enforcement Contact</div>
                                <div class="detail-value scrollable" id="modalLawEnforcement"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Security or Other Intervention</div>
                                <div class="detail-value scrollable" id="modalSecurityIntervention"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Incident Response</div>
                                <div class="detail-value scrollable" id="modalIncidentResponse"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Contributing Factors</div>
                                <div class="detail-value scrollable" id="modalContributingFactors"></div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Submitted</div>
                                <div class="detail-value" id="modalSubmitted"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Modal styles */
    .modal {
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }

    .modal-content {
        background-color: var(--surface-color);
        margin: 2% auto;
        padding: 0;
        border-radius: 0.5rem;
        width: 95%;
        max-width: 1000px;
        max-height: 95vh;
        box-shadow: var(--shadow-lg);
        animation: modalSlideIn 0.3s ease-out;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--background-color);
        border-radius: 0.5rem 0.5rem 0 0;
        flex-shrink: 0; /* Prevent header from shrinking */
    }

    .modal-header-buttons {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .modal-header h2 {
        margin: 0;
        color: var(--text-primary);
        font-size: 1.25rem;
    }

    .close {
        color: var(--text-secondary);
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
    }

    .close:hover {
        color: var(--text-primary);
    }

    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
        max-height: calc(95vh - 120px); /* Account for header height */
    }

    /* Custom scrollbar for modal body */
    .modal-body::-webkit-scrollbar {
        width: 8px;
    }

    .modal-body::-webkit-scrollbar-track {
        background: var(--background-color);
        border-radius: 4px;
    }

    .modal-body::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
    }

    .modal-body::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }

    .incident-details {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .detail-row {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .detail-label {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .detail-value {
        color: var(--text-primary);
        line-height: 1.6;
        margin-bottom: 1rem;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .detail-value.scrollable {
        max-height: 200px;
        overflow-y: auto;
        padding: 0.75rem;
        background-color: var(--background-color);
        border-radius: 0.375rem;
        border: 1px solid var(--border-color);
    }

    .detail-value.scrollable::-webkit-scrollbar {
        width: 8px;
    }

    .detail-value.scrollable::-webkit-scrollbar-track {
        background: var(--background-color);
        border-radius: 4px;
    }

    .detail-value.scrollable::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
    }

    .detail-value.scrollable::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }

    /* Detail sections */
    .detail-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .detail-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    /* Two Column Layout */
    .modal-columns {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
    }

    .modal-column {
        flex: 1;
        min-width: 0; /* Prevents flex items from overflowing */
    }

    .detail-section.full-width {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--primary-color);
    }

    /* Incident type badge styling */
    .incident-type-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 500;
        white-space: nowrap;
        background-color: var(--primary-color);
        color: white;
    }

    /* Table row hover effect */
    .incident-row:hover {
        background-color: var(--background-color) !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    /* Filter controls container */
    .filter-controls {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        align-items: center;
        flex-wrap: wrap;
        padding: 1rem;
        background-color: var(--background-color);
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
    }

    /* Date filters */
    .date-filters {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    /* Corrective Actions Styles */
    .corrective-actions-container {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .corrective-actions-textarea {
        min-height: 120px;
        resize: vertical;
        font-family: inherit;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .corrective-actions-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        border-radius: 0.25rem;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Responsive modal */
    @media (max-width: 768px) {
        .modal-content {
            width: 98%;
            margin: 1% auto;
            max-height: 98vh;
        }
        
        .modal-header {
            padding: 1rem;
        }
        
        .modal-body {
            padding: 1rem;
            max-height: calc(98vh - 100px); /* Account for smaller header on mobile */
        }
        
        .detail-row {
            gap: 0.25rem;
        }
        
        .detail-value {
            padding: 0.5rem;
        }
        
        .detail-value.scrollable {
            max-height: 120px;
            padding: 0.5rem;
        }
        
        .filter-controls {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        
        .date-filters {
            justify-content: center;
        }
        
        .sort-controls {
            justify-content: center;
        }

        /* Mobile: Stack columns vertically */
        .modal-columns {
            flex-direction: column;
            gap: 1rem;
        }

        .modal-column {
            width: 100%;
        }
    }

    /* Checkbox styles */
    .form-checkbox {
        width: 1rem;
        height: 1rem;
        margin: 0;
        cursor: pointer;
        accent-color: var(--primary-color);
    }

    .form-checkbox:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .form-checkbox-label {
        cursor: pointer;
        user-select: none;
    }

    .form-checkbox-label:has(+ .form-checkbox:disabled) {
        cursor: not-allowed;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentSearch = '';
let currentStartDate = '';
let currentEndDate = '';
let currentSortBy = 'submitted_at';
let currentSortOrder = 'desc';
let incidents = [];

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const clearDatesBtn = document.getElementById('clearDates');
    const sortBySelect = document.getElementById('sortBy');
    const sortOrderSelect = document.getElementById('sortOrder');
    const incidentsContainer = document.getElementById('incidentsContainer');

    // Debounce function for search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Load incidents
    async function loadIncidents() {
        try {
            incidentsContainer.innerHTML = '<div class="loading">Loading incidents...</div>';
            
            const params = new URLSearchParams({
                search: currentSearch,
                start_date: currentStartDate,
                end_date: currentEndDate,
                sort_by: currentSortBy,
                sort_order: currentSortOrder
            });
            
            const response = await fetch(`/admin/incidents?${params}`);
            const result = await response.json();
            
            if (result.success) {
                incidents = result.incidents;
                renderIncidents();
            } else {
                incidentsContainer.innerHTML = '<div class="alert alert-error">Error loading incidents</div>';
            }
        } catch (error) {
            console.error('Error:', error);
            incidentsContainer.innerHTML = '<div class="alert alert-error">Error loading incidents</div>';
        }
    }

    // Render incidents table
    function renderIncidents() {
        if (incidents.length === 0) {
            incidentsContainer.innerHTML = `
                <div class="empty-state">
                    <h3>No incidents found</h3>
                    <p>${currentSearch ? 'No incidents match your search criteria.' : 'No incidents have been reported yet.'}</p>
                </div>
            `;
            return;
        }

        const tableHTML = `
            <table class="table">
                <thead>
                    <tr>
                        <th>Incident #</th>
                        <th>Reporter</th>
                        <th>Type</th>
                        <th>Incident Date/Time</th>
                        <th>Location</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    ${incidents.map(incident => `
                        <tr class="incident-row" data-incident-id="${incident.id}" style="cursor: pointer;">
                            <td><strong>#${incident.id}</strong></td>
                            <td>${escapeHtml(incident.reporter_name)}</td>
                            <td><span class="badge incident-type-badge">${escapeHtml(incident.incident_type)}</span></td>
                            <td>${formatDateTime(incident.incident_datetime)}</td>
                            <td>${escapeHtml(incident.location.length > 30 ? incident.location.substring(0, 30) + '...' : incident.location)}</td>
                            <td>${escapeHtml(incident.incident_description.length > 80 ? incident.incident_description.substring(0, 80) + '...' : incident.incident_description)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        incidentsContainer.innerHTML = tableHTML;
    }

    // Utility functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDateTime(dateTimeStr) {
        const date = new Date(dateTimeStr);
        return date.toLocaleString();
    }

    // Event listeners
    const debouncedSearch = debounce(function(value) {
        currentSearch = value;
        loadIncidents();
    }, 300);

    searchInput.addEventListener('input', function() {
        debouncedSearch(this.value);
    });

    // Date filter event listeners
    startDateInput.addEventListener('change', function() {
        currentStartDate = this.value;
        loadIncidents();
    });

    endDateInput.addEventListener('change', function() {
        currentEndDate = this.value;
        loadIncidents();
    });

    // Clear dates button
    clearDatesBtn.addEventListener('click', function() {
        startDateInput.value = '';
        endDateInput.value = '';
        currentStartDate = '';
        currentEndDate = '';
        loadIncidents();
    });

    sortBySelect.addEventListener('change', function() {
        currentSortBy = this.value;
        loadIncidents();
    });

    sortOrderSelect.addEventListener('change', function() {
        currentSortOrder = this.value;
        loadIncidents();
    });

    // Modal functionality
    const modal = document.getElementById('incidentModal');
    const closeBtn = document.querySelector('.close');
    const exportPdfModalBtn = document.getElementById('exportPdfModalBtn');
    const saveModalBtn = document.getElementById('saveModalBtn');
    const correctiveActionsTextarea = document.getElementById('modalCorrectiveActions');
    
    // Track unsaved changes
    let hasUnsavedChanges = false;
    let originalCorrectiveActions = '';
    
    // Function to update button states based on unsaved changes
    function updateButtonStates() {
        if (hasUnsavedChanges) {
            exportPdfModalBtn.disabled = true;
            saveModalBtn.disabled = false;
        } else {
            exportPdfModalBtn.disabled = false;
            saveModalBtn.disabled = true;
        }
    }
    
    // Function to check for unsaved changes
    function checkForUnsavedChanges() {
        const currentValue = correctiveActionsTextarea.value.trim();
        hasUnsavedChanges = currentValue !== originalCorrectiveActions;
        updateButtonStates();
    }
    
    // Close modal when clicking the X button
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });
    
    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal.style.display === 'block') {
            modal.style.display = 'none';
        }
    });
    
    // Track changes in corrective actions textarea
    correctiveActionsTextarea.addEventListener('input', checkForUnsavedChanges);
    correctiveActionsTextarea.addEventListener('paste', function() {
        setTimeout(checkForUnsavedChanges, 10); // Small delay to allow paste to complete
    });
    
    // Save button functionality
    saveModalBtn.addEventListener('click', async function() {
        const incidentId = correctiveActionsTextarea.getAttribute('data-incident-id');
        const newCorrectiveActions = correctiveActionsTextarea.value.trim();
        const notifyReporter = document.getElementById('notifyReporterCheckbox').checked;
        
        if (!incidentId) {
            alert('Error: Incident ID not found');
            return;
        }
        
        if (!newCorrectiveActions) {
            alert('Please enter corrective actions before saving');
            return;
        }
        
        const originalText = saveModalBtn.textContent;
        saveModalBtn.textContent = 'Saving...';
        saveModalBtn.disabled = true;
        
        try {
            // Get current timestamp and username
            const timestamp = new Date().toLocaleString();
            const username = '{{ current_user.username }}'; // This will be replaced by the server
            
            // Prepare the data to send
            const dataToSend = {
                corrective_actions: newCorrectiveActions,
                notify_reporter: notifyReporter,
                add_audit_trail: true
            };
            
            const response = await fetch(`/admin/incidents/${incidentId}/corrective-actions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend)
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update the incidents array with the new data
                const incidentIndex = incidents.findIndex(inc => inc.id == incidentId);
                if (incidentIndex !== -1) {
                    incidents[incidentIndex].corrective_actions = result.corrective_actions;
                }
                
                // Clear the textarea and refresh audit trail
                correctiveActionsTextarea.value = '';
                const auditTrailDisplay = document.getElementById('auditTrailDisplay');
                const auditTrailRow = document.getElementById('auditTrailRow');
                
                if (result.corrective_actions && result.corrective_actions.trim()) {
                    auditTrailDisplay.textContent = result.corrective_actions;
                    auditTrailRow.style.display = 'block';
                } else {
                    auditTrailRow.style.display = 'none';
                }
                
                // Update original value and reset unsaved changes
                originalCorrectiveActions = '';
                hasUnsavedChanges = false;
                updateButtonStates();
                
                // Close the modal after successful save
                setTimeout(() => {
                    const modalElement = document.getElementById('incidentModal');
                    if (modalElement) {
                        modalElement.style.display = 'none';
                    }
                }, 100);
                
                // Silent save - no alert popup
            } else {
                alert('Error saving corrective actions: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while saving corrective actions. Please try again.');
        } finally {
            saveModalBtn.textContent = originalText;
            saveModalBtn.disabled = false;
        }
    });
    
    // PDF Export functionality for modal
    exportPdfModalBtn.addEventListener('click', async function() {
        const originalText = exportPdfModalBtn.textContent;
        exportPdfModalBtn.textContent = 'Generating...';
        exportPdfModalBtn.disabled = true;
        
        try {
            // Get the current incident data from the modal
            const incidentId = document.getElementById('modalCorrectiveActions').getAttribute('data-incident-id');
            const incidentData = incidents.find(inc => inc.id == incidentId);
            
            if (!incidentData) {
                alert('Error: Incident data not found');
                return;
            }
            
            // Create form data object
            const formDataObj = {
                incident_id: incidentData.id || '',
                reporter_name: incidentData.reporter_name || '',
                reporter_job_title: incidentData.reporter_job_title || '',
                reporter_email: incidentData.reporter_email || '',
                reporter_phone: incidentData.reporter_phone || '',
                incident_datetime: incidentData.incident_datetime || '',
                incident_type: incidentData.incident_type || '',
                location: incidentData.location || '',
                incident_description: incidentData.incident_description || '',
                persons_involved: incidentData.persons_involved || '',
                threats_weapons: incidentData.threats_weapons || '',
                medical_treatment: incidentData.medical_treatment || '',
                law_enforcement: incidentData.law_enforcement || '',
                security_intervention: incidentData.security_intervention || '',
                incident_response: incidentData.incident_response || '',
                contributing_factors: incidentData.contributing_factors || '',
                corrective_actions: document.getElementById('modalCorrectiveActions').value || ''
            };
            
            const response = await fetch('/export_modal_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formDataObj)
            });
            
            if (response.ok) {
                // Create blob from response
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `incident_report_${incidentData.id}_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // Silent PDF export - no popup
            } else {
                const errorData = await response.json();
                alert('Error generating PDF: ' + (errorData.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while generating the PDF. Please try again.');
        } finally {
            exportPdfModalBtn.textContent = originalText;
            exportPdfModalBtn.disabled = false;
        }
    });
    
    // Function to show incident details in modal
    function showIncidentDetails(incident) {
        // Update modal title with incident number
        document.getElementById('modalTitle').textContent = `Incident Details - #${incident.id}`;
        
        // Reporter information
        document.getElementById('modalReporter').textContent = incident.reporter_name || 'Anonymous';
        document.getElementById('modalJobTitle').textContent = incident.reporter_job_title || 'Not provided';
        document.getElementById('modalEmail').textContent = incident.reporter_email || 'Not provided';
        document.getElementById('modalPhone').textContent = incident.reporter_phone || 'Not provided';
        
        // Incident details
        document.getElementById('modalIncidentType').textContent = incident.incident_type;
        document.getElementById('modalIncidentDateTime').textContent = formatDateTime(incident.incident_datetime);
        document.getElementById('modalLocation').textContent = incident.location;
        document.getElementById('modalIncidentDescription').textContent = incident.incident_description;
        document.getElementById('modalPersonsInvolved').textContent = incident.persons_involved;
        
        // Additional details (show "Not provided" for empty fields)
        document.getElementById('modalThreatsWeapons').textContent = incident.threats_weapons || 'Not provided';
        document.getElementById('modalMedicalTreatment').textContent = incident.medical_treatment || 'Not provided';
        document.getElementById('modalLawEnforcement').textContent = incident.law_enforcement || 'Not provided';
        document.getElementById('modalSecurityIntervention').textContent = incident.security_intervention || 'Not provided';
        document.getElementById('modalIncidentResponse').textContent = incident.incident_response || 'Not provided';
        document.getElementById('modalContributingFactors').textContent = incident.contributing_factors || 'Not provided';
        
        // Corrective Actions - populate textarea and audit trail
        const correctiveActionsTextarea = document.getElementById('modalCorrectiveActions');
        const auditTrailRow = document.getElementById('auditTrailRow');
        const auditTrailDisplay = document.getElementById('auditTrailDisplay');
        
        // Clear the textarea for new input
        correctiveActionsTextarea.value = '';
        
        // Show audit trail if there are existing corrective actions
        if (incident.corrective_actions && incident.corrective_actions.trim()) {
            auditTrailRow.style.display = 'block';
            auditTrailDisplay.textContent = incident.corrective_actions;
        } else {
            auditTrailRow.style.display = 'none';
        }
        
        // Handle notification checkbox
        const notifyReporterCheckbox = document.getElementById('notifyReporterCheckbox');
        const hasReporterEmail = incident.reporter_email && incident.reporter_email.trim() !== '';
        
        if (hasReporterEmail) {
            notifyReporterCheckbox.disabled = false;
            notifyReporterCheckbox.checked = false; // Default to unchecked
        } else {
            notifyReporterCheckbox.disabled = true;
            notifyReporterCheckbox.checked = false;
        }
        
        document.getElementById('modalSubmitted').textContent = formatDateTime(incident.submitted_at);
        
        // Store incident ID for saving
        correctiveActionsTextarea.setAttribute('data-incident-id', incident.id);
        
        // Show delete button for master admins
        const deleteBtn = document.getElementById('deleteIncidentBtn');
        if (deleteBtn) {
            deleteBtn.style.display = 'inline-block';
            deleteBtn.setAttribute('data-incident-id', incident.id);
        }
        
        // Initialize unsaved changes tracking
        originalCorrectiveActions = incident.corrective_actions || '';
        hasUnsavedChanges = false;
        updateButtonStates();
        
        modal.style.display = 'block';
    }
    
    // Add click event listeners to table rows after rendering
    function addTableRowListeners() {
        const rows = document.querySelectorAll('.incident-row');
        rows.forEach(row => {
            row.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                try {
                    const incidentId = parseInt(this.getAttribute('data-incident-id'));
                    
                    // Find the incident data from the incidents array
                    const incidentData = incidents.find(inc => inc.id === incidentId);
                    
                    if (incidentData) {
                        showIncidentDetails(incidentData);
                    } else {
                        console.error('Incident not found with ID:', incidentId);
                    }
                } catch (error) {
                    console.error('Error finding incident data:', error);
                }
            });
        });
    }
    
    // Update renderIncidents to add event listeners
    const originalRenderIncidents = renderIncidents;
    renderIncidents = function() {
        originalRenderIncidents();
        addTableRowListeners();
    };

    // Delete incident handler (Master Admin only)
    const deleteIncidentBtn = document.getElementById('deleteIncidentBtn');
    if (deleteIncidentBtn) {
        deleteIncidentBtn.addEventListener('click', async function() {
            const incidentId = this.getAttribute('data-incident-id');
            if (!incidentId) return;
            
            const incident = incidents.find(inc => inc.id == parseInt(incidentId));
            if (!incident) return;
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete Incident #${incidentId}?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            // Double confirmation for safety
            if (!confirm(`Final confirmation: Delete Incident #${incidentId}?\n\nThis will permanently remove this incident from the system.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/incidents/${incidentId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Remove from incidents array
                    incidents = incidents.filter(inc => inc.id !== parseInt(incidentId));
                    
                    // Close modal
                    document.getElementById('incidentModal').style.display = 'none';
                    
                    // Reload incidents list
                    loadIncidents();
                    
                    // Show success message
                    alert(`Incident #${incidentId} has been deleted successfully.`);
                } else {
                    alert('Error: ' + (result.message || 'Failed to delete incident'));
                }
            } catch (error) {
                console.error('Error deleting incident:', error);
                alert('Error deleting incident. Please try again.');
            }
        });
    }

    // Initial load
    loadIncidents();
});
</script>
{% endblock %} 