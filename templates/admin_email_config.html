{% extends "base.html" %}

{% block title %}Email Configuration - Incident Reporting System{% endblock %}

{% block content %}
<div class="card">
    <h1 style="margin-bottom: 1.5rem; color: var(--text-primary);">Email Configuration</h1>
    
    <p style="margin-bottom: 2rem; color: var(--text-secondary);">
        Configure email settings to receive notifications when incidents are reported.
    </p>
    
    <form method="POST" action="{{ url_for('save_email_config') }}">
        <!-- Email Server Configuration (Master Admin only) -->
        {% if is_master_admin %}
        <div style="margin-bottom: 2rem; padding: 1.5rem; background-color: var(--background-color); border-radius: 0.5rem; border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.1rem;">SMTP Server Configuration</h3>
            
            <div class="form-group">
                <label for="mail_server" class="form-label">SMTP Server <span style="color: var(--danger-color);">*</span></label>
                <input type="text" id="mail_server" name="mail_server" class="form-input" 
                       value="{{ email_config.mail_server if email_config else 'smtp.gmail.com' }}"
                       placeholder="smtp.gmail.com" required>
                <small style="color: var(--text-secondary); font-size: 0.875rem;">
                    Common servers: smtp.gmail.com, smtp.outlook.com, smtp.yahoo.com
                </small>
            </div>

            <div class="form-group">
                <label for="mail_port" class="form-label">Port <span style="color: var(--danger-color);">*</span></label>
                <input type="number" id="mail_port" name="mail_port" class="form-input" 
                       value="{{ email_config.mail_port if email_config else 25 }}"
                       placeholder="25" required>
                <small style="color: var(--text-secondary); font-size: 0.875rem;">
                    Common ports: 25 (relay, no auth), 587 (TLS), 465 (SSL)
                </small>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="mail_use_tls" name="mail_use_tls" 
                           {% if email_config and email_config.mail_use_tls %}checked{% endif %}>
                    <span class="form-label" style="margin-bottom: 0;">Use TLS (Recommended)</span>
                </label>
                <small style="color: var(--text-secondary); font-size: 0.875rem;">
                    Enable TLS encryption for secure email transmission. Uncheck for port 25 relay servers.
                </small>
            </div>
        </div>
        {% endif %}

        <!-- Authentication (Master Admin only) -->
        {% if is_master_admin %}
        <div style="margin-bottom: 2rem; padding: 1.5rem; background-color: var(--background-color); border-radius: 0.5rem; border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.1rem;">Authentication</h3>
            
            <div class="form-group">
                <label for="mail_username" class="form-label">Email Address (Optional)</label>
                <input type="email" id="mail_username" name="mail_username" class="form-input" 
                       value="{{ email_config.mail_username if email_config else '' }}"
                       placeholder="your-email@gmail.com">
                <small style="color: var(--text-secondary); font-size: 0.875rem;">
                    Optional: The email address used to authenticate with the SMTP server. Leave blank for relay servers (port 25) that don't require authentication.
                </small>
            </div>

            <div class="form-group">
                <label for="mail_password" class="form-label">Password/App Password (Optional)</label>
                <div style="position: relative;">
                    <input type="password" id="mail_password" name="mail_password" class="form-input" 
                           value="{{ email_config.mail_password if email_config else '' }}"
                           placeholder="Your email password or app password" style="padding-right: 3rem;">
                    <button type="button" onclick="togglePassword('mail_password')" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary); font-size: 1rem;" title="Show/Hide Password">
                        <span id="mail_password-toggle">üëÅÔ∏è</span>
                    </button>
                </div>
                <small style="color: var(--text-secondary); font-size: 0.875rem;">
                    Optional: Required only if your SMTP server requires authentication. For Gmail, use an App Password. Leave blank for relay servers (port 25) that don't require authentication.
                </small>
            </div>

            <div class="form-group">
                <label for="mail_default_sender" class="form-label">Sender Email <span style="color: var(--danger-color);">*</span></label>
                <input type="email" id="mail_default_sender" name="mail_default_sender" class="form-input" 
                       value="{{ email_config.mail_default_sender if email_config else '' }}"
                       placeholder="noreply@company.com" required>
                <small style="color: var(--text-secondary); font-size: 0.875rem;">
                    The email address that will appear as the sender
                </small>
            </div>
        </div>
        {% endif %}

        <!-- Recipients (All users can edit) -->
        <div style="margin-bottom: 2rem; padding: 1.5rem; background-color: var(--background-color); border-radius: 0.5rem; border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.1rem;">Notification Recipients</h3>
            
            <div class="form-group">
                <label for="mail_recipients" class="form-label">Recipients <span style="color: var(--danger-color);">*</span></label>
                
                <!-- Recipients list with add/delete functionality -->
                <div id="recipientsList" style="margin-bottom: 1rem;">
                    {% if email_config and email_config.mail_recipients %}
                        {% for email in email_config.mail_recipients.split(',') %}
                            {% set email = email.strip() %}
                            {% if email %}
                            <div class="recipient-item" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background-color: var(--surface-color); border-radius: 0.375rem; border: 1px solid var(--border-color);">
                                <span style="flex: 1; color: var(--text-primary);">{{ email }}</span>
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeRecipient(this)" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Remove</button>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                
                <!-- Add new recipient -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="email" id="newRecipient" class="form-input" placeholder="email@company.com" style="flex: 1;">
                    <button type="button" class="btn btn-primary" onclick="addRecipient()">Add Recipient</button>
                </div>
                
                <!-- Hidden textarea for form submission -->
                <textarea id="mail_recipients" name="mail_recipients" class="form-input form-textarea" 
                          style="display: none;"
                          required>{{ email_config.mail_recipients if email_config else '' }}</textarea>
                <small style="color: var(--text-secondary); font-size: 0.875rem;">
                    Add email addresses to receive incident notifications. Click "Add Recipient" to add, or "Remove" to delete.
                </small>
            </div>
        </div>

        <!-- Status (Master Admin only) -->
        {% if is_master_admin %}
        <div style="margin-bottom: 2rem; padding: 1.5rem; background-color: var(--background-color); border-radius: 0.5rem; border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.1rem;">Status</h3>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="is_active" name="is_active" 
                           {% if not email_config or email_config.is_active %}checked{% endif %}>
                    <span class="form-label" style="margin-bottom: 0;">Enable Email Notifications</span>
                </label>
                <small style="color: var(--text-secondary); font-size: 0.875rem;">
                    When enabled, email notifications will be sent when incidents are reported
                </small>
            </div>
        </div>
        {% endif %}

        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">Save Configuration</button>
            <button type="button" id="testEmailBtn" class="btn btn-outline">Test Email</button>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </form>
</div>

<div id="messageContainer" style="display: none;"></div>
{% endblock %}

{% block extra_js %}
<script>
// Function to update the hidden textarea with current recipients
function updateRecipientsTextarea() {
    const recipientsList = document.getElementById('recipientsList');
    const recipients = [];
    recipientsList.querySelectorAll('.recipient-item span').forEach(span => {
        const email = span.textContent.trim();
        if (email) {
            recipients.push(email);
        }
    });
    document.getElementById('mail_recipients').value = recipients.join(', ');
}

// Function to add a new recipient
function addRecipient() {
    const newRecipientInput = document.getElementById('newRecipient');
    const email = newRecipientInput.value.trim();
    
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    
    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('Please enter a valid email address');
        return;
    }
    
    // Check if email already exists
    const recipientsList = document.getElementById('recipientsList');
    const existingEmails = Array.from(recipientsList.querySelectorAll('.recipient-item span')).map(span => span.textContent.trim().toLowerCase());
    if (existingEmails.includes(email.toLowerCase())) {
        alert('This email address is already in the list');
        return;
    }
    
    // Create new recipient item
    const recipientItem = document.createElement('div');
    recipientItem.className = 'recipient-item';
    recipientItem.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background-color: var(--surface-color); border-radius: 0.375rem; border: 1px solid var(--border-color);';
    recipientItem.innerHTML = `
        <span style="flex: 1; color: var(--text-primary);">${email}</span>
        <button type="button" class="btn btn-danger btn-sm" onclick="removeRecipient(this)" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Remove</button>
    `;
    
    recipientsList.appendChild(recipientItem);
    newRecipientInput.value = '';
    updateRecipientsTextarea();
}

// Function to remove a recipient
function removeRecipient(button) {
    if (confirm('Are you sure you want to remove this recipient?')) {
        const recipientItem = button.closest('.recipient-item');
        recipientItem.remove();
        updateRecipientsTextarea();
    }
}

// Allow Enter key to add recipient
document.addEventListener('DOMContentLoaded', function() {
    const newRecipientInput = document.getElementById('newRecipient');
    if (newRecipientInput) {
        newRecipientInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addRecipient();
            }
        });
    }
    
    // Initialize recipients textarea on page load
    updateRecipientsTextarea();
});

function togglePassword(fieldId) {
    const passwordField = document.getElementById(fieldId);
    const toggleButton = document.getElementById(fieldId + '-toggle');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        toggleButton.textContent = 'üôà';
        toggleButton.title = 'Hide Password';
    } else {
        passwordField.type = 'password';
        toggleButton.textContent = 'üëÅÔ∏è';
        toggleButton.title = 'Show Password';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const testEmailBtn = document.getElementById('testEmailBtn');
    const messageContainer = document.getElementById('messageContainer');
    
    function showMessage(message, type) {
        messageContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        messageContainer.style.display = 'block';
        
        // Scroll to message
        messageContainer.scrollIntoView({ behavior: 'smooth' });
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 5000);
        }
    }
    
    testEmailBtn.addEventListener('click', async function() {
        const originalText = testEmailBtn.textContent;
        testEmailBtn.textContent = 'Sending Test...';
        testEmailBtn.disabled = true;
        
        try {
            const response = await fetch('/admin/email-config/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage(result.message, 'success');
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('An error occurred while sending the test email. Please try again.', 'error');
        } finally {
            testEmailBtn.textContent = originalText;
            testEmailBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}
