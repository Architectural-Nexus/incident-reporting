# HTTP Virtual Host - Redirects to HTTPS
<VirtualHost *:80>
    ServerName incidents.your-domain.com  # Replace with your actual subdomain
    DocumentRoot /opt/incident-reports
    
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://incidents.your-domain.com/
    
    # Logs
    ErrorLog /var/log/httpd/incident_reports_error.log
    CustomLog /var/log/httpd/incident_reports_access.log combined
</VirtualHost>

# HTTPS Virtual Host - Main Configuration
<VirtualHost *:443>
    ServerName incidents.your-domain.com  # Replace with your actual subdomain
    DocumentRoot /opt/incident-reports
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/incident-reports.crt      # Replace with your certificate path
    SSLCertificateKeyFile /etc/ssl/private/incident-reports.key # Replace with your private key path
    
    # Modern SSL Configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # Security headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';"
    Header always set X-Robots-Tag "noindex, nofollow, nosnippet, noarchive"
    
    # Static files served directly by Apache (better performance)
    Alias /static /opt/incident-reports/static
    <Directory "/opt/incident-reports/static">
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 30 days"
        Header append Cache-Control "public, immutable"
    </Directory>
    
    # Favicon
    Alias /favicon.ico /opt/incident-reports/static/assets/favicon/favicon-32x32.ico
    <Location "/favicon.ico">
        ExpiresActive On
        ExpiresDefault "access plus 30 days"
    </Location>
    
    # Robots.txt
    Alias /robots.txt /opt/incident-reports/robots.txt
    <Location "/robots.txt">
        SetHandler default-handler
        Header set Content-Type "text/plain"
    </Location>
    
    # Security - Block access to sensitive files
    <DirectoryMatch "/\.">
        Require all denied
    </DirectoryMatch>
    
    <FilesMatch "\.(env|log|ini|conf)$">
        Require all denied
    </FilesMatch>
    
    # Enable mod_proxy for application
    ProxyPreserveHost On
    ProxyPass /static !
    ProxyPass /favicon.ico !
    ProxyPass /robots.txt !
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/
    
    # Proxy headers
    ProxyPassReverse / http://127.0.0.1:8000/
    ProxyPassReverseAdjustHeaders On
    
    # Timeout settings
    ProxyTimeout 60
    
    # Logs
    ErrorLog /var/log/httpd/incident_reports_error.log
    CustomLog /var/log/httpd/incident_reports_access.log combined
    
    # Compression (if mod_deflate is enabled)
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
</VirtualHost>
